name: Deploy Django to Server

on:
  push:
    branches: [ master, dev ]

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup SSH access
        uses: webfactory/ssh-agent@v0.5.4
        with:
            ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no root@43.160.207.67 << 'EOF'
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²: åˆ†æ”¯ = ${{ github.ref_name }}"
          
          # å¦‚æžœæ²¡è£… gitï¼Œå°±å…ˆå®‰è£…
          if ! command -v git &> /dev/null; then
            echo "ðŸ“¦ install git..."
            yum install -y git
          fi
          
          # æ·»åŠ  GitHub åˆ° known_hostsï¼ˆä¿¡ä»» github.comï¼‰
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          
          BRANCH="${{ github.ref_name }}"
          
          # æŒ‰åˆ†æ”¯è®¾ç½®è·¯å¾„å’Œæ–‡ä»¶
          if [ "$BRANCH" = "master" ]; then
            PROJECT_DIR="/www/autoDepoly-master"
            COMPOSE_FILE="docker-compose.master.yml"
            ENV_FILE=".env.master"
            ENV_CONTENT='${{ secrets.ENV_MASTER }}'
          elif [ "$BRANCH" = "dev" ]; then
            PROJECT_DIR="/www/autoDepoly-dev"
            COMPOSE_FILE="docker-compose.dev.yml"
            ENV_FILE=".env.dev"
            ENV_CONTENT='${{ secrets.ENV_DEV }}'
          else
            echo "âŒ ä¸æ”¯æŒçš„åˆ†æ”¯: $BRANCH"
            exit 1
          fi
          
          # å¦‚æžœç›®å½•ä¸å­˜åœ¨, æˆ–è€…å…³é”® docker-compose æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°± cloneï¼Œå¦åˆ™å°±è¿›å…¥ç›®å½•
          if [ ! -d "$PROJECT_DIR" ] || [ ! -f "$PROJECT_DIR/$COMPOSE_FILE" ]; then
            echo "ðŸ“ ç›®å½•ä¸å­˜åœ¨æˆ–è€…ç¼ºå°‘å…³é”®æ–‡ä»¶ï¼Œæ‰§è¡Œ git clone"
            rm -rf $PROJECT_DIR
            git clone --branch $BRANCH git@github.com:hmonster7/autoDepoly.git $PROJECT_DIR
          fi
          cd $PROJECT_DIR
          
          echo "ðŸ“¥ æ‹‰å– $BRANCH æœ€æ–°ä»£ç "
          # æ‹‰å–æœ€æ–°ä»£ç 
          # git fetch origin $BRANCH
          # git checkout $BRANCH
          git pull origin $BRANCH
          
          echo "ðŸ“ å†™å…¥çŽ¯å¢ƒå˜é‡åˆ° $ENV_FILE"
          # å†™å…¥ .env æ–‡ä»¶ï¼ˆæ­¤æ—¶ç›®å½•å·²å­˜åœ¨ï¼‰
          echo "$ENV_CONTENT" > $ENV_FILE
          
          
          # æ£€æŸ¥nginxé…ç½®ç›®å½•å’Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          NGINX_DIR="/www/nginx-proxy-manager"
          NGINX_COMPOSE="$NGINX_DIR/docker-compose.nginx.yml"
          
          # ä»…åœ¨ç›®å½•ä¸å­˜åœ¨æ—¶åˆ›å»º
          if [ ! -d "$NGINX_DIR" ]; then
            echo "ðŸ“ åˆ›å»ºnginxé…ç½®ç›®å½•"
            mkdir -p $NGINX_DIR
          fi
          
          # ä»…åœ¨é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æ—¶åˆ›å»º
          if [ ! -f "$NGINX_COMPOSE" ]; then
            echo "ðŸ“ åˆ›å»ºnginxé…ç½®æ–‡ä»¶"
            cat > $NGINX_COMPOSE << 'EOFNGINX'
          version: "3"
          services:
            nginx-proxy-manager:
              container_name: nginx-proxy-manager
              image: 'jc21/nginx-proxy-manager:latest'
              restart: unless-stopped
              ports:
                - '80:80'
                - '81:81'
                - '443:443'
              volumes:
                - ./data:/data
                - ./letsencrypt:/etc/letsencrypt
                - /www/autoDepoly-master/static:/code/static/master
                - /www/autoDepoly-dev/static:/code/static/dev
        
          networks:
            default:
              name: nginx_default
          EOFNGINX
          
            # ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
            mkdir -p $NGINX_DIR/data
            mkdir -p $NGINX_DIR/letsencrypt
          else
            echo "âœ… nginxé…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          fi
          
          echo "ðŸ§© æ£€æŸ¥ nginx-proxy-manager æ˜¯å¦å·²è¿è¡Œ"
          if [ -z "$(docker ps -q -f name=nginx-proxy-manager)" ]; then
            echo "ðŸ”µ nginx-proxy-manager æœªè¿è¡Œï¼Œå¯åŠ¨ä¸­..."
            cd $NGINX_DIR
            docker compose -f docker-compose.nginx.yml up -d
            cd $PROJECT_DIR  # è¿”å›žé¡¹ç›®ç›®å½•
          else
            echo "ðŸŸ¢ nginx-proxy-manager å·²åœ¨è¿è¡Œï¼Œæ— éœ€å¯åŠ¨"
          fi
          
          
          echo "ðŸ› ï¸ å¯åŠ¨ Docker æœåŠ¡ï¼š$COMPOSE_FILE"
          # å¯åŠ¨ Docker æœåŠ¡
          docker compose -f $COMPOSE_FILE down
          docker compose -f $COMPOSE_FILE up -d --build
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼š$BRANCH -> $PROJECT_DIR"
          
          EOF